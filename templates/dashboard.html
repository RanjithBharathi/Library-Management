{% extends 'base.html' %} {% block content %}
<div class="container-fluid py-4">
  <h2 class="mb-4">
    <i class="fas fa-chart-line me-2"></i>Library Analytics Dashboard
  </h2>

  <!-- Stats Cards Row -->
  <div class="row mb-4">
    <div class="col-md-2">
      <div class="card bg-primary text-white">
        <div class="card-body text-center">
          <i class="fas fa-book fa-2x mb-2"></i>
          <h3>{{ total_books }}</h3>
          <p class="mb-0">Total Books</p>
        </div>
      </div>
    </div>
    <div class="col-md-2">
      <div class="card bg-success text-white">
        <div class="card-body text-center">
          <i class="fas fa-check-circle fa-2x mb-2"></i>
          <h3>{{ available_books }}</h3>
          <p class="mb-0">Available</p>
        </div>
      </div>
    </div>
    <div class="col-md-2">
      <div class="card bg-info text-white">
        <div class="card-body text-center">
          <i class="fas fa-users fa-2x mb-2"></i>
          <h3>{{ total_readers }}</h3>
          <p class="mb-0">Readers</p>
        </div>
      </div>
    </div>
    <div class="col-md-2">
      <div class="card bg-warning text-dark">
        <div class="card-body text-center">
          <i class="fas fa-hand-holding fa-2x mb-2"></i>
          <h3>{{ active_borrows }}</h3>
          <p class="mb-0">Active Borrows</p>
        </div>
      </div>
    </div>
    <div class="col-md-2">
      <div class="card bg-danger text-white">
        <div class="card-body text-center">
          <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
          <h3>{{ overdue_count }}</h3>
          <p class="mb-0">Overdue</p>
        </div>
      </div>
    </div>
    <div class="col-md-2">
      <div class="card bg-secondary text-white">
        <div class="card-body text-center">
          <i class="fas fa-dollar-sign fa-2x mb-2"></i>
          <h3>${{ "%.2f"|format(total_fines) }}</h3>
          <p class="mb-0">Fines Owed</p>
        </div>
      </div>
    </div>
  </div>

  <div class="row mb-4">
    <!-- Monthly Borrows Chart -->
    <div class="col-md-8">
      <div class="card">
        <div class="card-header bg-light">
          <h5 class="mb-0">
            <i class="fas fa-chart-bar me-2"></i>Monthly Borrowing Trends
          </h5>
        </div>
        <div class="card-body">
          <canvas id="monthlyChart" height="100"></canvas>
        </div>
      </div>
    </div>

    <!-- Quick Actions -->
    <div class="col-md-4">
      <div class="card">
        <div class="card-header bg-light">
          <h5 class="mb-0"><i class="fas fa-bolt me-2"></i>Quick Actions</h5>
        </div>
        <div class="card-body">
          <a
            href="{{ url_for('add_book') }}"
            class="btn btn-primary w-100 mb-2"
          >
            <i class="fas fa-plus me-2"></i>Add New Book
          </a>
          <a
            href="{{ url_for('borrowadd') }}"
            class="btn btn-success w-100 mb-2"
          >
            <i class="fas fa-hand-holding me-2"></i>New Borrow
          </a>
          <a
            href="{{ url_for('view_fines') }}"
            class="btn btn-warning w-100 mb-2"
          >
            <i class="fas fa-dollar-sign me-2"></i>Manage Fines
          </a>
          <a
            href="{{ url_for('view_suggestions') }}"
            class="btn btn-info w-100 mb-2"
          >
            <i class="fas fa-lightbulb me-2"></i>Book Suggestions
          </a>
          <a
            href="{{ url_for('all_reviews') }}"
            class="btn btn-secondary w-100"
          >
            <i class="fas fa-star me-2"></i>View Reviews
          </a>
        </div>
      </div>
    </div>
  </div>

  <div class="row mb-4">
    <!-- Most Borrowed Books -->
    <div class="col-md-6">
      <div class="card">
        <div class="card-header bg-light">
          <h5 class="mb-0">
            <i class="fas fa-fire me-2 text-danger"></i>Most Popular Books
          </h5>
        </div>
        <div class="card-body">
          <table class="table table-hover">
            <thead>
              <tr>
                <th>#</th>
                <th>Title</th>
                <th>Author</th>
                <th>Borrows</th>
              </tr>
            </thead>
            <tbody>
              {% for book in most_borrowed %}
              <tr>
                <td>{{ loop.index }}</td>
                <td>
                  <a href="{{ url_for('viewbook', id=book.id) }}"
                    >{{ book.title }}</a
                  >
                </td>
                <td>{{ book.author }}</td>
                <td>
                  <span class="badge bg-primary">{{ book.borrow_count }}</span>
                </td>
              </tr>
              {% else %}
              <tr>
                <td colspan="4" class="text-center">No data available</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Top Rated Books -->
    <div class="col-md-6">
      <div class="card">
        <div class="card-header bg-light">
          <h5 class="mb-0">
            <i class="fas fa-star me-2 text-warning"></i>Top Rated Books
          </h5>
        </div>
        <div class="card-body">
          <table class="table table-hover">
            <thead>
              <tr>
                <th>#</th>
                <th>Title</th>
                <th>Rating</th>
                <th>Reviews</th>
              </tr>
            </thead>
            <tbody>
              {% for book in top_rated %}
              <tr>
                <td>{{ loop.index }}</td>
                <td>
                  <a href="{{ url_for('book_reviews', id=book.id) }}"
                    >{{ book.title }}</a
                  >
                </td>
                <td>
                  {% for i in range(book.avg_rating|int) %}
                  <i class="fas fa-star text-warning"></i>
                  {% endfor %} ({{ "%.1f"|format(book.avg_rating) }})
                </td>
                <td>
                  <span class="badge bg-info">{{ book.review_count }}</span>
                </td>
              </tr>
              {% else %}
              <tr>
                <td colspan="4" class="text-center">No reviews yet</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <!-- Most Active Readers -->
    <div class="col-md-6">
      <div class="card">
        <div class="card-header bg-light">
          <h5 class="mb-0">
            <i class="fas fa-trophy me-2 text-success"></i>Most Active Readers
          </h5>
        </div>
        <div class="card-body">
          <table class="table table-hover">
            <thead>
              <tr>
                <th>#</th>
                <th>Name</th>
                <th>Total Borrows</th>
              </tr>
            </thead>
            <tbody>
              {% for reader in most_active_readers %}
              <tr>
                <td>
                  {% if loop.index == 1 %}
                  <i class="fas fa-medal text-warning"></i>
                  {% elif loop.index == 2 %}
                  <i class="fas fa-medal text-secondary"></i>
                  {% elif loop.index == 3 %}
                  <i class="fas fa-medal" style="color: #cd7f32"></i>
                  {% else %} {{ loop.index }} {% endif %}
                </td>
                <td>
                  <a href="{{ url_for('borrowerlook', id=reader.id) }}"
                    >{{ reader.first_name }} {{ reader.last_name }}</a
                  >
                </td>
                <td>
                  <span class="badge bg-success"
                    >{{ reader.total_borrows }}</span
                  >
                </td>
              </tr>
              {% else %}
              <tr>
                <td colspan="3" class="text-center">No data available</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Pending Suggestions -->
    <div class="col-md-6">
      <div class="card">
        <div class="card-header bg-light">
          <h5 class="mb-0">
            <i class="fas fa-lightbulb me-2 text-info"></i>Pending Book
            Suggestions
          </h5>
        </div>
        <div class="card-body">
          <table class="table table-hover">
            <thead>
              <tr>
                <th>Title</th>
                <th>Author</th>
                <th>By</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
              {% for suggestion in recent_suggestions %}
              <tr>
                <td>{{ suggestion.suggested_title }}</td>
                <td>{{ suggestion.suggested_author }}</td>
                <td>{{ suggestion.reader.first_name }}</td>
                <td>
                  <form
                    method="POST"
                    action="{{ url_for('approve_suggestion', id=suggestion.id) }}"
                    style="display: inline"
                  >
                    <button type="submit" class="btn btn-sm btn-success">
                      <i class="fas fa-check"></i>
                    </button>
                  </form>
                  <form
                    method="POST"
                    action="{{ url_for('reject_suggestion', id=suggestion.id) }}"
                    style="display: inline"
                  >
                    <button type="submit" class="btn btn-sm btn-danger">
                      <i class="fas fa-times"></i>
                    </button>
                  </form>
                </td>
              </tr>
              {% else %}
              <tr>
                <td colspan="4" class="text-center">No pending suggestions</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          <a
            href="{{ url_for('view_suggestions') }}"
            class="btn btn-outline-primary btn-sm"
            >View All Suggestions</a
          >
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Chart.js Library -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // Monthly Borrowing Chart
  const ctx = document.getElementById('monthlyChart').getContext('2d');
  new Chart(ctx, {
      type: 'bar',
      data: {
          labels: [{% for stat in monthly_stats %}'{{ stat.month }}'{% if not loop.last %}, {% endif %}{% endfor %}],
          datasets: [{
              label: 'Books Borrowed',
              data: [{% for stat in monthly_stats %}{{ stat.count }}{% if not loop.last %}, {% endif %}{% endfor %}],
              backgroundColor: 'rgba(54, 162, 235, 0.7)',
              borderColor: 'rgba(54, 162, 235, 1)',
              borderWidth: 1
          }]
      },
      options: {
          responsive: true,
          scales: {
              y: {
                  beginAtZero: true,
                  ticks: {
                      stepSize: 1
                  }
              }
          },
          plugins: {
              legend: {
                  display: false
              }
          }
      }
  });
</script>
{% endblock %}
